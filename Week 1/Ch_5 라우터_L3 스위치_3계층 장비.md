# Ch_5 라우터/L3 스위치: 3계층 장비

---

라우터(Router)는 3계층에서 동작하는 여러 네트워크 장비의 대표격으로 **경로를 지정해주는 장비**이다. 

라우터에 들어오는 패킷의 목적지 IP 주소를 확인하고 자신이 가진 경로(Router) 정보를 이용해 패킷을 최적의 경로로 포워딩한다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled.png)

> OSI 7계층상의 3계층 장비인 라우터 통신
> 

### 라우터? L3스위치?

<aside>
💡 스위치는 2계층 장비이지만 라우터처럼 3계층에서 동작하는 L3 스위치라고 부르는 장비도 사용되고 있다. 최근 기술 발달로 라우터와 L3 스위치를 구분하기는 어렵다. 이번 학습은 라우터로 설명하고 있지만 L3 스위치로도 모두 동일하게 적용되는 내용이다.

</aside>

---

# 5.1 라우터의 동작 방식과 역할

라우터는 다양한 경로 정보를 수집해 **최적의 경로를 라우팅 테이블에 저장**한 후 패킷이 라우터로 들어오면 도착지 IP 주소와 라우팅 테이블을 비교해 최선의 경로로 패킷을 내보낸다.

<aside>
📌 스위치와 반대로 들어온 **패킷의 목적지 주소가 라우팅 테이블에 없으면 패킷을 버린다.**

</aside>

또한 라우터는 패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거한 후 새로운 2계층 헤더를 만들어낸다. 위에서 차례로 설명한 라우터의 동작 방식을 **경로 지정, 브로드캐스트 컨트롤, 프로토콜 변환**이라고 한다.

---

## 경로 지정

라우터의 가장 중요한 역할은 경로 지정이다. 경로 정보를 모아 라우팅 테이블을 만들고 패킷이 라우터로 들어오면 패킷의 도착지 IP 주소를 확인해 경로를 지정하고 패킷을 포워딩한다.

<aside>
📢 IP 주소는 네트워크 주소와 호스트 주소로 나뉘어 설계되어 로컬, 원격지를 구분할 수 있고 이를 바탕으로 라우터가 원격지에 있는 적절한 경로로 패킷을 포워딩한다.

</aside>

라우터는 경로를 지정해 패킷을 포워딩하는 역할을 두 가지로 구분해 수행한다. 

1. 경로 정보를 얻는 역할
2. 경로 정보를 확인하고 패킷을 포워딩하는 역할

라우터는 자신이 얻은 경로 정보에 포함되는 패킷만 포워딩하므로 정확한 목적지 경로를 얻는 것이 매우 중요하다.

다양한 방법으로 경로 정보를 얻을 수 있는데 IP 주소를 입력하면서 자연스럽게 인접 네트워크 정보를 얻는 방법과 관리자가 직접 경로 정보를 입력하는 방법, 라우터끼리 서로 경로 정보를 자동으로 교환하는 방법이 있다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%201.png)

> 라우터의 가장 중요한 역할은 1. 경로 정보 얻기, 2. 얻은 경로 정보로 패킷을 포워딩하기 이다.
> 

---

## 브로드캐스트 컨트롤(Broadcast Control)

스위치는 패킷의 도착지 주소를 모르면 어딘가에 존재할지 모를 장비와의 통신을 위해 플러딩해 패킷을 모든 포트에 전송한다. 

<aside>
🍇 네트워크 성능에 무리가 갈 수 있다고 생각할 수 있지만, LAN은 크기가 작아 플러딩에 대한 영향이 작고 네트워크 인터페이스 카드(NIC)에서 자신의 주소와 패킷의 도착지 주소가 다르면 패킷을 버리기 때문에 이런 플러딩 작업은 네트워크에 큰 무리를 주지 않는다.

</aside>

반면, 라우터는 패킷을 원격지로 보내는 것을 목표로 개발되어 3계증에서 동작하고 **분명한 도착지 정보가 있을 때만 통신을 허락**한다.

라우터는 바로 연결되어 있는 네트워크 정보를 제외하고 경로 습득 설정을 하지 않으면 패킷을 포워딩할 수 없다. **라우터의 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는다.**

라우터의 이 기능을 이용해 브로드캐스트가 다른 네트워크로 전파되는 것을 막을 수 있다. 이 기능을 **브로드캐스트 컨트롤/멀티캐스트 컨트롤** 이라고 한다.

<aside>
😁 네트워크에 브로드캐스트가 많이 발생하는 경우, **라우터로 네트워크를 분리**하면 브로드캐스트 네트워크를 분할해 **네트워크 성능을 높일 수 있다.**

</aside>

---

## 프로토콜 변환

라우터의 또 다른 역할은 서로 다른 프로토콜로 구성된 네트워크를 연결하는 것이다.

-

현대 네트워크는 이더넷으로 수렴되므로 이 역할이 많이 줄었지만 (일부는 사용) 과거에는 LAN에서 사용하는 프로토콜과 WAN에서 사용하는 프로토콜이 전혀 다른, 완전히 구분된 공간이였기 때문에 LAN 기술이 WAN 기술로 변환해야만 원격지 네트워크와의 통신이 가능했고 이 역할을 라우터가 담당했었다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%202.png)

> LAN과 WAN 기술을 변환해주는 라우터
> 

라우터는 3계증에서 동작하므로 패킷이 들어오면 2계층 헤더 정보를 새로 만들어 외부로 보낸다.

이 기능을 이용하여 전혀 다른 기술 간 변환이 가능해진다.

*ex. WAN 구간은 PPP와 같은 WAN 프로토콜 사용, LAN 구간은 이더넷 프로토콜 사용중 LAN 구간에서 패킷이 라우터를 지나면서 2계층까지의 헤더가 벗겨지고 WAN 구간으로 나올 때 PPP 헤더로 변경되어 프로토콜이 변환된다.*

---

# 5.2 경로 지정 - 라우팅/스위칭

라우터의 가장 중요한 두 가지 역할인 경로를 얻는 방법과 얻은 경로를 바탕으로 패킷을 포워딩하는 동작에 대해 자세히 학습하겠다.

### 라우팅 동작과 라우팅 테이블

현대 인터넷에서는 단말부터 목적지까지의 경로를 모두 책임지는 것이 아니라 인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악한 후 라우터로 패킷을 포워딩한다.

네트워크를 한 단계씩 뛰어넘는다는 의미로 이 기법을 **홉-바이-홉(Hop-by-Hop) 라우팅**이라고 부르고 인접한 라우터를 **넥스트 홉(Next Hop)**이라고 부른다.

<aside>
👣 라우터는 전체 경로를 파악하지 않고 최적의 넥스트 홉을 선택해 보내준다.

</aside>

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%203.png)

> 홉-바이-홉 라우팅 기법을 사용한 인터넷
> 

넥스트 홉을 지정할 때는 일반적으로 세 가지 방법을 사용할 수 있다.

- 다음 라우터의 IP를 지정하는 방법(넥스트 홉 IP 주소)
- 라우터의 나가는 인터페이스를 지정하는 방법
- 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시에 지정하는 방법

*라우터에서 넥스트홉을 지정할 때는 일반적으로 상대방 라우터의 인터페이스 IP 주소를 지정하는 방법을 사용한다.*

특수한 경우에만 라우터의 나가는 인터페이스를 지정하는 방법을 쓸 수 있는데 상대방 넥스트 홉 라우터의 IP를 모르더라도 MAC 주소 정보를 알아낼 수 있을 때만 사용할 수 있다.

<aside>
💡 상대방의 MAC 주소를 알 필요가 없거나 (PPP,HLDC 사용) 상대방 라우터에서 프록시 ARP이 동작해 IP 주소를 모르더라도 MAC 주소를 알 수 있을 때와 같이 한정된 조건에서만 사용할 수 있다.

</aside>

> 이런 경우는 특수한 경우이므로 상대방 IP 주소를 넥스트 홉으로 지정해야 한다.
> 

인터페이스를 설정할 때는 라우터의 **나가는 물리 인터페이스**를 지정하는 것이 일반적이지만 IP 주소와 인터페이스를 동시에 사용할 때는 **VLAN 인터페이스와 같은 논리적인 인터페이스**를 사용할 수 있다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%204.png)

> 넥스트 홉을 지정하는 방법에는 출력 인터페이스와 넥스트 홉 IP 주소가 있다.
> 

라우터가 패킷 포워딩 경로를 선택할 때 출발지는 고려하지 않는다.

**출발지와 상관없이 목적지 주소와 라우팅 테이블을 비교해 결정**한다.

그래서 라우팅 테이블을 만들 때는 목적지 정보만 수집하고 패킷이 들어오면 목적지 주소를 확인해 패킷을 넥스트 홉으로 포워딩한다.

라우팅 테이블에 저장하는 데이터에는 다음과 같은 정보가 포함된다.

- 목적지 주소
- 넥스트 홉 IP 주소, 나가는 로컬 인터페이스(선택 가능)

---

### 라우팅(라우터가 경로 정보를 얻는 방법)

라우터가 경로 정보를 얻는 방법은 매우 다양하지만 다음 3가지 방법으로 크게 구분할 수 있다.

1. 다이렉트 커넥티드
2. 스태틱 라우팅
3. 다이나믹 라우팅

**다이렉트 커넥티드**

IP 주소와 서브넷 마스크를 알면 해당 IP가 속한 네트워크 주소 정보를 알 수 있고 IP 유효 범위도 알 수 있다.

이렇게 계산을 톨해 자동으로 라우팅 테이블을 만들게 되며 형성되는 경로를 **다이렉트 커넥티드(Direct Connected)**라고 한다.

<aside>
⛔ 다이렉트 커넥티드로 생성되는 경로 정보는 인터페이스에 IP를 설정하면 자동 생성되는 정보이므로 수정, 삭제가 불가능하다. 다만 지목한 네트워크 인터페이스 자체가 비활성화, 삭제되면 자동으로 사라진다.

</aside>

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%205.png)

> 다이렉트 커넥티드 - 라우터에서 connected로 표현된다.
> 

**스태틱 라우팅**

관리자가 넥스트 홉을 **직접 지정하는 방식**이다. 

다이렉트 커넥티드와 마찬가지로 지목한 네트워크 자체가 비활성화, 삭제되면 자동으로 사라진다.

<aside>
⛔ 간혹, 사라지지 않는 경우도 있는데 이는 지목한 네트워크 인터페이스의 물리 인터페이스가 아닌 논리 인터페이스가 남아 있는 경우이다.

</aside>

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%206.png)

> 스태틱 라우팅
> 

**다이나믹 라우팅**

네트워크의 양이 방대해질 경우, 관리자가 스태틱 라우팅, 즉 수작업으로 라우팅 테이블을 관리하는 것은 힘든 일이다. **라우터끼리 경로 정보와 상태를 교환하여 자동으로 라우팅 테이블을 형성**한다.

현재는 대부분 다이나믹 라우팅을 사용 중이다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%207.png)

> 다이나믹 라우팅
> 

### 스위칭(라우터가 경로를 지정하는 방법)

라우팅 테이블을 참고하여 포워딩하는 작업을 스위칭이라고 한다.

한번 스위칭 작업을 하면, 해당 내역을 캐싱되어서 다음에는 **라우팅 테이블을 참고 및 연산하는 과정을 거치지 않고 빠르게 스위칭**이 가능해진다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%208.png)

> 라우팅 테이블과 패킷 스위칭
> 

<aside>
💡 TIP. 라우팅 테이블에서 가장 좋은 항목을 찾는 방법(알고리즘)인 롱기스트 프리픽스 매치(Longest Prefix Match)가 있다. Exact Match가 아닌 경우 이 알고리즘에 기반한 연산을 하는데, 이 비용을 아끼려고 캐싱을 하는 것.

</aside>

### 라우팅, 스위칭 우선순위

위에서 학습한 것처럼 라우팅 테이블은 가장 좋은 경로 정보만 모아놓은 **핵심정보**이다.

경로 정보를 모아놓은 토폴로지 테이블에서 좋은 경로 정보의 우선 순위는 **경로 정보를 받은 방법과 거리를 기준**으로 한다.

라우터의 라우팅, 스위칭 역할을 하나로 묶은 전체적인 우선순위는 다음과 같다.

![Untitled](Ch_5%20%E1%84%85%E1%85%A1%E1%84%8B%E1%85%AE%E1%84%90%2038466/Untitled%209.png)

> 라우팅 우선순위
> 

기존 정보보다 우선순위가 높은 라우팅 정보를 입력하고 싶다면 해당 우선순위를 참조해 입력하면 된다.

현재 라우팅 테이블에 스태틱 라우팅으로 입력한 경로 정보가 있다면 스태틱 라우팅의 *AD값이 1이므로 이 정보보다 좋은 경로를 만들기는 어렵다.

*AD(Administrative Distancd, 관리 거리): 라우팅 프로토콜들이 서로 네트워크 경로를 이용해 통신을 할 때 **경로의** **우선순위**.

---