# Ch_6 로드 밸런서/방화벽: 4계층 장비(세션 장비)

---

# 6.1 4계층 장비의 특징

- 세션 테이블
    
    세션 장비는 세션 테이블 기반으로 운영된다.
    
    세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요하다.
    
    세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재한다. 이 부분에 대한 고려가 필요하다.
    
- Symmetric(대칭) 경로 요구
    
    Inbound와 Outbound 경로가 일치해야 한다.
    
- 정보 변경(로드 벨런서의 경우)
    
    IP 주소가 변경되어 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다.
    

---

# 6.2 로드 밸런서

**서버의 부하를 줄여주기 위한 역할을 로드 밸런서**라 부른다.

트래픽을 분배해주는 기능 때문인데 로드 밸런서가 서비스에 접근하는 public IP를 가지고 있고 내부적으로 요청을 시스템의 실제 IP로 변경하여 다른 서버로 보낸다.

**따라서 로드 밸런서는 그 자체로 장비의 이름이 아닌 ‘역할’의 이름이다.**

4L 스위치 로드밸런서, 소프트웨어형 로드 밸런서 등 형태는 다양하다. 

### L4, L7 로드 밸런서

로드 밸런서는 L4, L7 로드 밸런서로 구분될 수 있다.

최근의 로드 밸런서는 L4, L7의 기능을 모두 지원하므로 L4 기능만 전용으로 제공하는 로드 밸런서 장비는 찾기 어려워졌고 **어떻게 설정했는지, 무슨 정보를 사용하는지에 따라 4계층 정보로만 분산처리를 할 경우** L4 로드 밸런서라고 한다.

<aside>
💡 단순히 443 포트냐, 80 포트냐만을 본다면 L4 로드 밸런서이다.

</aside>

L7 로드 밸런서는 **HTTP, FTP, SMTP와 같은 프로토콜을 기반**으로 로드밸런싱한다.

그러므로, HTTP의 해더나 url 주소를 기반으로 연결된 서버를 분기한다면 그건 L7 로드 밸런서라는 이야기이다.

이러한 로드 밸런서를 **ADC(Application Delivery Controller)**라고 부른다.

클라우드에서는 이 둘을 구분하는데 AWS의 **NLB**(network load balancer)는 L4이고, **ALB**(application load balancer)는 L7이다.

---

### L4 스위치

L4 스위치는 용어 그대로 4계층에서 동작하면서 **로드 밸런서 기능이 있는 스위치**이다.

내부 동작 방식은 4계층 로드 밸런서이지만 외형은 스위치처럼 여러 개의 포트를 가지고 있다.

<aside>
📢 서버형 로드 밸런서나 소프트웨어 형태의 로드 밸런서도 있지만 다양한 네트워크 구성이 가능한 스위치형 로드 밸런서가 가장 대중화되어 있다.

</aside>

L4 스위치는 부하 분산, 성능 최적화, 리다이렉션 기능을 제공한다.

![Untitled](https://user-images.githubusercontent.com/84123877/177037617-20966064-c334-4bbc-ac92-96b0d4eabc72.png)

> L4 스위치를 사용한 부하 분산
> 

L4 스위치가 동작하려면 가상 서버(Vitual Server), 가상 IP(Virtual IP), 리얼 서버(Real Server),와 리얼 IP(Real IP)를 설정해야 한다.

- 가상 서버
    
    사용자가 바라보는 실제 서비스
    

- 가상 IP
    
    사용자가 접근해야 하는 서비스 IP
    

- 리얼 서버
    
    실제 서비스를 수행하는 서버
    

- 리얼 IP
    
    실제 서버의 IP
    

여기서 L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할을 한다.

---

### ADC (Application Delivery Controller)

ADC는 어플리케이션 단(7L)에서 작동하는 로드 밸런서이다.

4계층에서 동작하는 L4 스위치와 달리 어플리케이션의 프로토콜 정보를 이용하여 **더 다양하고 섬세한 동작**을 할 수 있고 L4 스위치의 기능까지 겸임하는 경우가 대다수이다. 

 

<aside>
📢 로드 밸런싱 뿐만 아니라 리다이렉트, 캐싱, 압축, 인코딩 등 다양한 역할을 겸임한다.

</aside>

ADC의 활용 예를 들어본다면

- WAS에서 압축하는 것보다 ADC에서 압축하는게 서버 부하를 줄여주니까 ADC를 잘 활용하면 여러모로 좋다.
- SSL 프로토콜의 경우(HTTPS), 암호화, 복호화의 과정 자체가 일반 http 보다 부하가 많이 걸리므로, 엔드 유저에게 노출되는 ADC에서만 SSL 프로토콜을 사용하고, ADC와 실제 서버와의 통신은 가벼운 http를 사용할 수 있다.

반면 ADC와 달리 L4 스위치는 정말 Virtual ip, Virtual server, real ip, real server 로 구성되어 서비스 포트에 따라 특정 서버로 쏴주는 역할을 한다. 기본적인 로드 밸런싱을 한다고 보면 된다.

---

# 6.3 방화벽

네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용(permit)하거나 차단(Deny)하는 장비를 방화벽이라고 한다.

네트워크에서 보안을 제공하는 장비를 넓은의미에서 모두 방화벽의 일종으로 불러왔지만, 일반적으로 네트워크 3,4 계층에서 동작하고 세션을 인지, 관리하는 SPI(Stateful Packet Inspection) 엔진을 기반으로 동작하는 장비를 방화벽이라고 부른다.

![Untitled 1](https://user-images.githubusercontent.com/84123877/177037611-6619dc17-e775-4d2b-9c0b-b9d5acce6d89.png)

> 세션 테이블이 있는 방화벽
> 

방화벽은 NAT(Net Address Transation) 동작 방식과 유사하게 **세션 정보를 내부에 저장**한다.

패킷이 외부로 나갈 때 세션 정보를 저장하고 패킷이 외부에 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지를 가려낸다.

![Untitled 2](https://user-images.githubusercontent.com/84123877/177037616-693cc347-fee5-423d-8939-408ab2be874a.png)

> 방화벽은 세션 테이블을 이용해 패킷의 인과 관계를 파악한다.
> 

이 세션 테이블을 이용해 패킷의 인과 관계를 파악할 수 있어 정책을 간단히 유지할 수 있다.

상태 정보가 없으면 방화벽에서는 하나의 정책을 설정하기 위해 최소한 두 개의 양방향 정책이 함께 설정되어야 하며, 인터넷과 같은 불특정 다수와 통신해야 할 때는 정책의 복잡도가 많이 증가한다.

인터넷 방화벽에서의 기본 정책은 인터넷으로 나가는 모든 패킷을 허용하고 내부로 들어오는 모든 패킷을 차단하는 것이다.

<aside>
💡 **상태 테이블? 세션 테이블?**

 패킷의 상태 정보를 인지하는 스테이트풀(Stateful)로 동작하는 장비에 경우, 상태 정보를 갖고 있어 상태 테이블(State Table)이라고도 하고 해당 상태에 대한 세션  값을 유지하므로 세션 테이블(Session Table)이라고도 부른다. 여기선 세션 테이블로 용어를 통일해 학습하였다.

</aside>

---

# 6.4 4계층 장비를 통과할 때의 유의점 (세션 관리)

세션 장비는 일반적인 2, 3계층 네트워크 장비와 달리 세션을 이해하고 세션 테이블을 유지한다.

세션 장비의 기능으로는

- 세션 테이블 정보를 이용해 패킷을 변경
- 애플리케이션 성능을 최적화
- 보안 강화를 위해 패킷 포워드, 드롭

등이 있으며, 이런 기능을 충분히 활용하려면 애플리케이션과 세션 장비 간 세션 정보를 동일하게 유지해주거나 애플리케이션을 제작할 때 네트워크 중간에 있는 세션 정ㅂ를 고려햐 여러가지 기능을 추가해야한다.

<aside>
💡 특히 애플리케이션의 세션 시간과 서비스 방향성을 고려, 비대칭 경로를 피하는것이 중요

</aside>

### 세션 테이블 유지, 세션 정보 동기화

종단 장비에서 통신을 시작하면 중간에 있는 세션 장비는 해당 세션 상태를 테이블에 기록한다. 

통신이 없더라도 종단 간 통신이 정상적으로 종료되지 않았다면 일정 시간 동안 세션 테이블을 유지한다.

하지만 이런 세션 테이블은 메모리에 저장되므로 메모리 사용률을 적절히 유지하기 위해 일정 시간만 세션 정보를 저장한다. 또한, 악의적인 공격자가 과도한 세션을 발생시켜 세션 테이블 생성을 방해하는 공격으로부터 시스템을 보호하기 위해 타임아웃값을 줄이기도 한다.

이런 여러가지 이유로 세션 정보를 무제한으로 줄 수 없고 여러 가지 애플리케이션 정보를 관리하므로 적당한 세션 타임아웃값을 유지한다.
