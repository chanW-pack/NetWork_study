# Alteon L4 기본 설정/로드밸런싱

---

### L4 기본 설정 순서

1. L4 IP 설정
2. 게이트웨이 설정
3. admpwd 설정 및 telnet 접속 활성화

### SLB 설정 순서

1. VLAN 생성과 Real IP 설정
2. Real server group 설정 후, real server ip 추가
3. 가상 IP 주소(VIP, 실제 외부에 알려지는 IP)아 서비스 타입 지정
4. 서버와 클라이언트 포트 Enable
5. SLB 활성화
6. 적용/저장

---

### 1. interface 설정

가장 먼저 cfg/ip/interface 1 에서 외부에서 L4에 접근할 수 있도록 L4 IP를 설정해준다.

```bash
main$ cfg                                       [configuration 메뉴로 들어가는 명령어]
configration$ ip                            [ip관련 설정을 위한 메뉴로 들어가는 명령어]
ip$ if 1                                [interface 설정 - 256개의 interface 설정 가능]
IP interface$ addr 10.10.1.4                                 [스위치의 interface 주소]
IP interface$ mask 255.255.255.0                                    [주소에 대한 mask]
IP interface$ broad 10.10.1.255                     [주소에 대한 브로드캐스트 address]
IP interface$ en                        [ip와 관련된 설정 후에는 반드시 enable 해야함]
IP interface$ apply/save                            [apply로 설정 활성화(메모리 저장)]
                                          [save로 NVRam에 저장하여 리부팅 후에도 사용]
# 약식 구성방법
main $ cfg/ip/if 1/addr 192.168.1.2/mask 255.255.255.0/broad 192.168.1.255/en
```

### 2. gateway 설정

cfg/ip/gw 1 에서 게이트웨이를 설정해준다.

```bash
main$ cfg
configuration$ ip
ip$ gw 1                              [gateway 를 설정 - gateway는 4개까지 설정 가능]
Default gateway 1$ addr 10.10.1.1                                [gateway 주소 설정]
Default gateway 1$ en                                    
Default gateway 1$ apply/save

# 약식 구성방법
main $ cfg/ip/gw 1/addr 192.168.1.1/en/apply/save
```

### 3. 스위치 기능 설정

cfg/sys/user 에서 admpw를 설정해준다.

초기 L4 패스워드는 admin이다.

(패스워드를 잊어버렸을 경우 password에 `forgetMe!` 를 입력하면 패스워드 변경이 가능하다.)

```bash
# 패스워드 변경
main$ cfg
configuration$ sys                                             [system 메뉴로 들어감]
system$ user                                      [user 메뉴에서 원하는 사용자를 선택]
User AccessControl$ admpw                    [administrator의 password를 변경시 선택]
Current password 입력/new password 입력
User AccessControl$ apply/save

# 약식 구성방법
main $ cfg/sys/user/admpw
```

외부에서 접근이 가능하도록 telnet 접속을 활성화 시켜준다. (cfg/sys)

```bash
# telnet 기능 활성화
main$ cfg
configuration$ sys
system$ tnet en      [telnet 서비스는 os 9.0에서 default disable이므로 활성화 시켜줌]
system$ apply/save
```

초기 상태에서는 vlan 1에 모든 포트가 포함되어 있기 때문에 아래 명령어는 생략해도 된다.

포트를 vlan 2 또는 vlan 3으로 나누어 사용할 때 포트를 나누기 위한 명령어이다.

즉, 아래 명령어는 vlan 1에 포트 1,2 번을 할당하겠다는 명령어이다.

```bash
# vlan 설정
main$ cfg
configuration$ vlan 1                [default로 모든 포트는 valn 1에 할당되어 있다.]
vlan 1$ add 1                         [vlan 1에서 필요한 포트를 빼오는 형식]
vlan 1$ add 2

# interface를 vlan에 할당할때는 ip 설정하는 부분에서 해당하는 vlan을 지정해 주면 된다.
# ex. main $ cfg/ip/if 2/addr 192.168.1.1/vlan 2/en
# ip를 설정하고 뒤에 해당 vlan을 지정한다.
```

## SLB 설정

---

### Real Server 구성

```bash
# Real Server 구성
main $ cfg
configuration $ slb                                             [slb 메뉴로 들어감]
layer4 $ real 1                                              [real server 1번 지정]
real server 1$ rip 192.168.1.3      [real server의 ip를 설정할때는 rip address이다]
real server 1$ en
real server 1$ ..                                 [마침표 두번으로 상위 메뉴로 이동]

# Real server 약식 구성방법
main $ c/sl/re 1/rip 192.168.1.3/en/../re 2/rip 192.168.1.4/en 방법으로 계속
```

### Group 지정

```bash
# Group 지정
Layer 4$ group 1
Real server group 1$ add 1/add 2/add 3/add 4            [Real server 틀을 추가한다.]
Real server group 1$ health                    [서버와의 health check 하는 기준 선택]
icmp|tcp|http|dns|pop3|smtp|nntp|ftp|imap|radius|sslh  [.. 중 하나를 선택할 수 있다.]

Real server group 1$ metric                                    [로드밸런싱 기법 선택]
leastconns|roundrobin|minmisses|hash|response|bandwidth           [.. 중 하나를 선택]

# Group 지정 약식 구성방법
main $ c/sl/gr 1/add 1/add 2/add 3/add 4/met round/heal http
```

### Virtual Server 구성

```bash
# virtual server 구성
Layer 4$ virt 1             [virtual IP 설정 메뉴. VIP는 256개 까지 사용할 수 있다.]
Virtual Server 1$ vip 192.168.1.10/en            [virtual ip를 설정하고 enable 진행]
Virtual Server 1$ service 80                                      [서비스 포트 지정]
Virtual Server 1 http Service $ group 1                  [서비스를 적용할 그룹 지정]
Virtual Server 1 http Serivce $ .. / ..                           [상위 메뉴로 이동]
Layer 4 $ on                                                     [SLB 전체를 활성화]
Virtual Server 1 http Service $ apply / save                              [저장하기] 
```

### port 구성, 지정

```bash
# Service port 구성하기
main $ cfg
Configuration $ slb
Layer 4 $ port 1
SLB port 1 $ client en       [client traffic 이 들어오는 포트에 client enable를 해준다]
SLB port 1 $ ..
Layer 4 $ port 2
SLB port 2 $ server en                [server가 물려있는 포트에 server enable를 해준다]
SLB port 2 $ apply/save

# User define port 지정하기(ex, 8080, 8001, 12000.....)
user define port를 알테온에서 설정하는 방법은 3가지가 있다.

1. 사용자의 destination port 가 80 이고 실제 service port가 다를경우(ex.8001)

Main $ cfg/slb/vi 1
Virtual Server 1$ se 80                                   [ 사용자의 트래픽은 80이다]
Virtual Server 1 http Service $ rport 8001           [real port 가 8001임을 지정한다]
Current real port:     80               
New pending real port: 8001                           [서비스 포트가 변경됨을 알려줌]
Virtual Server 1 http Service$ gr 1                 [서비스 하게될 리얼서버그룹 지정]
Current real server group:     1
New pending real server group: 1
Virtual Server 1 http Service$ apply              [apply해서 서비스를 활성화시켜준다]

2. 사용자의 destination port 가 실제 service port와 동일한경우
예를 들어 사용자가 http://www.cng.co.kr:8001 이라고 브라우저에 직접 치는 경우

Main $ cfg/slb/vi 1
Virtual Server 1$ se 8001                               [ 사용자의 트래픽은 8001이다]
Virtual Server 1 8001 Service $ gr 1                [서비스 하게될 리얼서버그룹 지정]
Current real server group:     1
New pending real server group: 1
 Virtual Server 1 http Service$ apply             [apply해서 서비스를 활성화시켜준다]
  
3. 사용자의 destination port 가 80 이고 실제 service port가 다른 여러개인 경우
예를 들어 사용자는 실제 서비스 포트를 전혀 모르고 80으로만 쿼리를 보내고
실제 서버의 서비스는 8080, 8001, 12000을 사용한다고할경우, 
알테온은 사용자의 쿼리가 어떤 서비스를 요구하는지 전혀 알수 없다.

따라서 이런 경우 각각의 서비스에 대한 각각의 vip를 설정해야한다.
설정사항은 1번과 같다.
```

### Filter 설정

필터는 cisco router에서 나오는 access-list와 동일한 것으로 보면 된다.
단지 alteon에서는 allow, deny 외에 redirection 이라는 필터링 기법을 지원한다.

redirection은 특정한 트래픽을 강제로 지정한 방향으로 가도록 만들어주는 필터이다.
주로 cache redirection에 이용되며, WCR(web cache redirection), APR(applicationRedirection) 에 쓰는 것이 보통이다.

filter는 1 부터 224 까지 쓸수 있으며 1이 가장 우선순위가 높다.

```bash
# Filter 설정하기
main # cfg
configuration # slb
layer 4 # fi 100                         [filter 번호 지정, 100번부터 지정하는게 보통]

filter 100 # sip 192.168.1.1/smask 255.255.255.255/dip 10.10.10.1/dmask

255.255.255.255/pro tcp/dpo 80/act deny/en

layer 4 # port 1/add 100/fi en     [slb port에 filter를 추가하고 filter enable를 해줌]
layer 4 # apply/save                                              [apply/save는 필수]

source ip가 192.168.1.1인 host가 destination ip 10.10.10.1 
destination 80port 로 올경우 deny 시켜라는 filter.
filter 는 소스 트래픽이 들어오는 포트에 지정.
```

---